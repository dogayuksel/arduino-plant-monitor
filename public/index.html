<!DOCTYPE html>
<html>
  <head>
    <style>
     * {
       font-family: sans-serif;
     }
     h1 {
       font-weight: 400;
     }
     body {
       margin: 40px 20px 220px 20px;
     }
    </style>
    <script src='https://d3js.org/d3.v5.min.js'></script>
  </head>
  <body>
    <h2>Last 2 Weeks</h2>
    <h1>Soil Moisture 1 and 2 / Temperature / Light</h1>
  </body>
  <script>
   const margin = { top: 20, bottom: 20, left: 40, right: 40 };
   const screenWidth = window.innerWidth ;
   const width = screenWidth > 1100 ? (screenWidth - 200) / 2 : screenWidth - 120;
   const height = width * 0.62;

   const findFirstDay = (data) => d3.min(data, d => new Date(d.date));
   const findLastDay = (data) => d3.max(data, d => new Date(d.date));

   const createXScale = (data, { margin, width }) => {
     const firstDay = findFirstDay(data);
     const lastDay = findLastDay(data);
     return d3
       .scaleTime()
       .domain([firstDay, lastDay])
       .range([margin.left, width - margin.right]);
   };
   const createXAxis = (xScale) => d3.axisBottom(xScale);

   const createHumidityYScale = ({ height, margin }) => {
     return d3
       .scaleLinear()
       .domain([700, 300])
       .range([height - margin.bottom, margin.top]);
   };
   const createHumidityYAxis = (yScale) => d3.axisLeft(yScale);

   const createTemperatureYScale = ({ height, margin }) => {
     return d3
       .scaleLinear()
       .domain([0, 400])
       .range([height - margin.bottom, margin.top]);
   };
   const createTemperatureYAxis = (yScale) => d3.axisLeft(yScale);

   const createLightYScale = ({ height, margin }) => {
     return d3
       .scaleLinear()
       .domain([0, 1024])
       .range([height - margin.bottom, margin.top]);
   };
   const createLightYAxis = (yScale) => d3.axisLeft(yScale);

   const data = fetch('{{SERVER_URL}}')
     .then(v => v.json())
     .then(data => {
       const xScale = createXScale(data.moisture1, { margin, width });
       const xAxis = createXAxis(xScale);

       const yScaleHumidity = createHumidityYScale({ height, margin })
       const yAxisHumidity = createHumidityYAxis(yScaleHumidity);
       const yScaleTemperature = createTemperatureYScale({ height, margin })
       const yAxisTemperature = createTemperatureYAxis(yScaleTemperature);
       const yScaleLight = createLightYScale({ height, margin })
       const yAxisLight = createLightYAxis(yScaleLight);

       const svgNodeHumidity1 = d3
         .select('body')
         .append('svg')
         .attr('height', height)
         .attr('width', width)
         .style('padding', '20px');

       const svgNodeHumidity2 = d3
         .select('body')
         .append('svg')
         .attr('height', height)
         .attr('width', width)
         .style('padding', '20px');

       const svgNodeTemperature = d3
         .select('body')
         .append('svg')
         .attr('height', height)
         .attr('width', width)
         .style('padding', '20px');

       const svgNodeLight = d3
         .select('body')
         .append('svg')
         .attr('height', height)
         .attr('width', width)
         .style('padding', '20px');

       svgNodeHumidity1
         .append('g')
         .attr(
           'transform',
           `translate(0, ${height - margin.bottom})`)
         .call(xAxis);

       svgNodeHumidity2
         .append('g')
         .attr(
           'transform',
           `translate(0, ${height - margin.bottom})`)
         .call(xAxis);

       svgNodeTemperature
         .append('g')
         .attr(
           'transform',
           `translate(0, ${height - margin.bottom})`)
         .call(xAxis);

       svgNodeLight
         .append('g')
         .attr(
           'transform',
           `translate(0, ${height - margin.bottom})`)
         .call(xAxis);

       svgNodeHumidity1
         .append('g')
         .attr('transform', `translate(${margin.left}, 0)`)
         .call(yAxisHumidity);

       svgNodeHumidity2
         .append('g')
         .attr('transform', `translate(${margin.left}, 0)`)
         .call(yAxisHumidity);

       svgNodeTemperature
         .append('g')
         .attr('transform', `translate(${margin.left}, 0)`)
         .call(yAxisTemperature);

       svgNodeLight
         .append('g')
         .attr('transform', `translate(${margin.left}, 0)`)
         .call(yAxisLight);

       const lineHumidity = d3
         .line()
         .x(function(d) { return xScale(new Date(d.date)); })
         .y(function(d) { return yScaleHumidity(d.value); });

       const lineTemperature = d3
         .line()
         .x(function(d) { return xScale(new Date(d.date)); })
         .y(function(d) { return yScaleTemperature(d.value); });

       const lineLight = d3
         .line()
         .x(function(d) { return xScale(new Date(d.date)); })
         .y(function(d) { return yScaleLight(d.value); });

       svgNodeHumidity1
         .append("path")
         .datum(Object.values(data.moisture1))
         .attr("fill", "none")
         .attr("stroke", "steelblue")
         .attr("stroke-width", 1.5)
         .attr("d", lineHumidity);

       svgNodeHumidity1
         .append("path")
         .datum(Object.values(data.moisture2))
         .attr("fill", "none")
         .attr("stroke", "crimson")
         .attr("stroke-width", 1.5)
         .attr("d", lineHumidity);

       svgNodeHumidity2
         .append("path")
         .datum(Object.values(data.moisture3))
         .attr("fill", "none")
         .attr("stroke", "steelblue")
         .attr("stroke-width", 1.5)
         .attr("d", lineHumidity);

       svgNodeHumidity2
         .append("path")
         .datum(Object.values(data.moisture4))
         .attr("fill", "none")
         .attr("stroke", "crimson")
         .attr("stroke-width", 1.5)
         .attr("d", lineHumidity);

       svgNodeTemperature
         .append("path")
         .datum(Object.values(data.temperature1))
         .attr("fill", "none")
         .attr("stroke", "crimson")
         .attr("stroke-width", 1.5)
         .attr("d", lineTemperature);

       svgNodeTemperature
         .append("path")
         .datum(Object.values(data.temperature2))
         .attr("fill", "none")
         .attr("stroke", "steelblue")
         .attr("stroke-width", 1.5)
         .attr("d", lineTemperature);

       svgNodeLight
         .append("path")
         .datum(Object.values(data.light1))
         .attr("fill", "none")
         .attr("stroke", "crimson")
         .attr("stroke-width", 1.5)
         .attr("d", lineLight);

       svgNodeLight
         .append("path")
         .datum(Object.values(data.light1))
         .attr("fill", "none")
         .attr("stroke", "steelblue")
         .attr("stroke-width", 1.5)
         .attr("d", lineLight);
     });
  </script>
</html>
